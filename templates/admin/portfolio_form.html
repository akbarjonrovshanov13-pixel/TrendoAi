{% extends 'admin/base_admin.html' %}

{% block title %}{% if portfolio %}Portfolio Tahrirlash{% else %}Yangi Portfolio{% endif %} - TrendoAI Admin{% endblock
%}

{% block content %}
<div class="admin-header">
    <h1>{% if portfolio %}‚úèÔ∏è Portfolio Tahrirlash{% else %}‚ûï Yangi Portfolio Qo'shish{% endif %}</h1>
    <a href="{{ url_for('admin_portfolio') }}" class="btn btn-secondary">‚Üê Orqaga</a>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
{% for category, message in messages %}
<div class="alert alert-{{ category }}">{{ message }}</div>
{% endfor %}
{% endif %}
{% endwith %}

<form method="POST" class="portfolio-form">
    <div class="form-section">
        <h3>üìù Asosiy Ma'lumotlar</h3>

        <div class="form-row">
            <div class="form-group">
                <label for="emoji">Emoji</label>
                <input type="text" id="emoji" name="emoji" value="{{ portfolio.emoji if portfolio else 'üöÄ' }}"
                    maxlength="10" placeholder="üöÄ">
            </div>
            <div class="form-group flex-grow">
                <label for="title">Loyiha Nomi *</label>
                <input type="text" id="title" name="title" value="{{ portfolio.title if portfolio else '' }}" required
                    placeholder="Masalan: E-Commerce Bot">
            </div>
        </div>

        <div class="form-group">
            <div class="label-with-ai">
                <label for="description">Tavsif *</label>
                <button type="button" id="ai-generate-btn" class="btn btn-ai">
                    ü§ñ AI bilan yozish
                </button>
            </div>
            <textarea id="description" name="description" rows="4" required
                placeholder="Loyiha haqida qisqacha ma'lumot...">{{ portfolio.description if portfolio else '' }}</textarea>
            <div id="ai-loading" class="ai-loading" style="display: none;">
                ‚è≥ AI yozmoqda...
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="category">Kategoriya</label>
                <select id="category" name="category">
                    <option value="bot" {% if portfolio and portfolio.category=='bot' %}selected{% endif %}>ü§ñ Telegram
                        Bot</option>
                    <option value="web" {% if portfolio and portfolio.category=='web' %}selected{% endif %}>üåê Web Sayt
                    </option>
                    <option value="ai" {% if portfolio and portfolio.category=='ai' %}selected{% endif %}>üß† AI Yechim
                    </option>
                    <option value="mobile" {% if portfolio and portfolio.category=='mobile' %}selected{% endif %}>üì±
                        Mobile</option>
                </select>
            </div>
            <div class="form-group flex-grow">
                <label for="technologies">Texnologiyalar</label>
                <input type="text" id="technologies" name="technologies"
                    value="{{ portfolio.technologies if portfolio else '' }}"
                    placeholder="Python, Flask, PostgreSQL (vergul bilan ajrating)">
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="price">üí∞ Narxi (Katalog uchun)</label>
                <input type="text" id="price" name="price" value="{{ portfolio.price if portfolio else '' }}"
                    placeholder="2,500,000 so'm">
            </div>

            <div class="form-row">
                <div class="form-group flex-grow">
                    <label for="link">Loyiha Havolasi</label>
                    <input type="url" id="link" name="link" value="{{ portfolio.link if portfolio else '' }}"
                        placeholder="https://example.com">
                </div>
                <div class="form-group flex-grow">
                    <label for="image_url">Rasm URL</label>
                    <input type="url" id="image_url" name="image_url"
                        value="{{ portfolio.image_url if portfolio else '' }}"
                        placeholder="https://example.com/image.jpg">
                </div>
            </div>

            <div class="form-group">
                <label for="features">Loyiha Imkoniyatlari (Features)</label>
                <input type="text" id="features" name="features" value="{{ portfolio.features if portfolio else '' }}"
                    placeholder="To'lov tizimi, Admin panel, Push xabarlar (vergul bilan ajrating)">
            </div>

            <div class="form-group">
                <label for="details">Loyiha Haqida Batafsil (Markdown qo'llab-quvvatlanadi)</label>
                <textarea id="details" name="details" rows="10"
                    placeholder="Loyiha qanday muammoni hal qildi? Qanday natijaga erishildi?">{{ portfolio.details if portfolio else '' }}</textarea>
            </div>
        </div>

        <div class="form-section">
            <h3>üîç SEO Sozlamalari</h3>

            <div class="form-group">
                <label for="meta_description">Meta Tavsif (160 belgi)</label>
                <textarea id="meta_description" name="meta_description" rows="2" maxlength="160"
                    placeholder="Qidiruv tizimlarida ko'rinadigan qisqa tavsif...">{{ portfolio.meta_description if portfolio else '' }}</textarea>
                <small class="char-count">0/160</small>
            </div>

            <div class="form-group">
                <label for="meta_keywords">Meta Kalit So'zlar</label>
                <input type="text" id="meta_keywords" name="meta_keywords"
                    value="{{ portfolio.meta_keywords if portfolio else '' }}"
                    placeholder="telegram bot, python, e-commerce (vergul bilan ajrating)">
            </div>
        </div>

        <div class="form-section">
            <h3>‚öôÔ∏è Sozlamalar</h3>

            <div class="form-row checkboxes">
                <label class="checkbox-label">
                    <input type="checkbox" name="is_published" {% if not portfolio or portfolio.is_published %}checked{%
                        endif %}>
                    <span>‚úÖ Chop etish (Saytda ko'rinadi)</span>
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" name="is_featured" {% if portfolio and portfolio.is_featured %}checked{%
                        endif %}>
                    <span>‚≠ê Featured (Ajratilgan loyiha)</span>
                </label>
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary btn-lg">
                {% if portfolio %}üíæ Saqlash{% else %}‚ûï Qo'shish{% endif %}
            </button>
            <a href="{{ url_for('admin_portfolio') }}" class="btn btn-secondary">Bekor qilish</a>
        </div>
</form>

<style>
    .portfolio-form {
        max-width: 800px;
    }

    .form-section {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        padding: 24px;
        margin-bottom: 24px;
    }

    .form-section h3 {
        margin-bottom: 20px;
        font-size: 1.1rem;
        color: var(--text-primary);
    }

    .form-row {
        display: flex;
        gap: 16px;
        margin-bottom: 16px;
    }

    .form-group {
        display: flex;
        flex-direction: column;
    }

    .form-group.flex-grow {
        flex: 1;
    }

    .form-group label {
        margin-bottom: 6px;
        font-weight: 600;
        color: var(--text-primary);
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
        padding: 12px 16px;
        background: var(--bg-elevated);
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        color: var(--text-primary);
        font-size: 1rem;
        font-family: inherit;
        transition: var(--transition-smooth);
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
    }

    .form-group input#emoji {
        width: 80px;
        font-size: 1.5rem;
        text-align: center;
    }

    .char-count {
        text-align: right;
        color: var(--text-muted);
        font-size: 0.8rem;
        margin-top: 4px;
    }

    .checkboxes {
        align-items: center;
    }

    .checkbox-label {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        padding: 12px 16px;
        background: var(--bg-elevated);
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        transition: var(--transition-smooth);
    }

    .checkbox-label:hover {
        border-color: var(--primary);
    }

    .checkbox-label input[type="checkbox"] {
        width: 20px;
        height: 20px;
    }

    .form-actions {
        display: flex;
        gap: 16px;
    }

    .btn-lg {
        padding: 14px 32px;
        font-size: 1.1rem;
    }

    @media (max-width: 768px) {
        .form-row {
            flex-direction: column;
        }
    }

    /* AI Button Styles */
    .label-with-ai {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 6px;
    }

    .btn-ai {
        background: linear-gradient(135deg, #8b5cf6, #6366f1);
        color: white;
        border: none;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn-ai:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
    }

    .btn-ai:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .ai-loading {
        color: var(--primary);
        font-size: 0.9rem;
        margin-top: 8px;
        animation: pulse 1.5s infinite;
    }

    @keyframes pulse {

        0%,
        100% {
            opacity: 1;
        }

        50% {
            opacity: 0.5;
        }
    }
</style>

<script>
    // Character counter for meta description
    const metaDesc = document.getElementById('meta_description');
    const charCount = document.querySelector('.char-count');

    metaDesc.addEventListener('input', function () {
        charCount.textContent = this.value.length + '/160';
    });

    // Initialize on load
    charCount.textContent = metaDesc.value.length + '/160';

    // AI Generate functionality
    const aiBtn = document.getElementById('ai-generate-btn');
    const aiLoading = document.getElementById('ai-loading');

    aiBtn.addEventListener('click', async function () {
        const title = document.getElementById('title').value.trim();
        const category = document.getElementById('category').value;

        if (!title) {
            alert("Iltimos, avval 'Loyiha Nomi' kiriting!");
            document.getElementById('title').focus();
            return;
        }

        aiBtn.disabled = true;
        aiBtn.textContent = '‚è≥ Generatsiya...';
        aiLoading.style.display = 'block';

        try {
            const response = await fetch(`/admin/api/generate-portfolio?title=${encodeURIComponent(title)}&category=${category}`);
            const data = await response.json();

            if (data.error) {
                alert('AI xatosi: ' + data.error);
            } else {
                if (data.description) document.getElementById('description').value = data.description;
                if (data.technologies) document.getElementById('technologies').value = data.technologies;
                if (data.features) document.getElementById('features').value = data.features;
                if (data.details) document.getElementById('details').value = data.details;
                if (data.meta_description) {
                    document.getElementById('meta_description').value = data.meta_description;
                    charCount.textContent = data.meta_description.length + '/160';
                }
                if (data.meta_keywords) document.getElementById('meta_keywords').value = data.meta_keywords;
            }
        } catch (error) {
            alert('Xatolik yuz berdi: ' + error.message);
        } finally {
            aiBtn.disabled = false;
            aiBtn.textContent = 'ü§ñ AI bilan yozish';
            aiLoading.style.display = 'none';
        }
    });
</script>
{% endblock %}